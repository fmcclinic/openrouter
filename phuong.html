<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI for my friends</title>
    <!-- Thêm các thư viện xử lý -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=30xj8le1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <!-- Biểu tượng -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        line-height: 1.6;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: #f9f9f9;
    }
    
    .top-bar {
        background-color: #f8f8f8;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .app-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin: 0;
        color: #333;
    }
    
    .settings-toggle {
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background-color 0.2s;
    }
    
    .settings-toggle:hover {
        background-color: #45a049;
    }
    
    .main-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 60px); /* Trừ đi chiều cao của top-bar */
        position: relative;
        overflow: hidden;
    }
    
    .settings-panel {
        background-color: #f0f0f0;
        padding: 15px 20px;
        border-bottom: 1px solid #ccc;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
    }
    
    .settings-panel.visible {
        max-height: 100vh;
        opacity: 1;
        overflow: auto;
    }
    
    .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow-y: auto;
    }
    
    .container, .settings { 
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        width: auto;
    }
    
    .chat-history {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fff;
    }
    
    textarea {
        width: 100%;
        height: 100px;
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-family: inherit;
        box-sizing: border-box;
        resize: vertical;
    }
    
    #system-prompt {
        height: 80px;
    }
    
    select, input {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }
    
    button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
        transition: background-color 0.2s;
    }
    
    button:hover {
        background-color: #45a049;
    }
    
    .button-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .response {
        white-space: pre-wrap;
        background-color: #f8f8f8;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        position: relative;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        position: relative;
    }
    
    .user {
        background-color: #e6f7ff;
    }
    
    .assistant {
        background-color: #f0f0f0;
    }
    
    .system {
        background-color: #fff3e0;
        border-left: 3px solid #ff9800;
    }
    
    .markdown-content {
        background-color: #f8f8f8;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        position: relative;
    }
    
    .markdown-content img {
        max-width: 100%;
        height: auto;
    }
    
    .markdown-content pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
    }
    
    .markdown-content code {
        font-family: monospace;
    }
    
    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
        margin-top: 20px;
        margin-bottom: 10px;
    }
    
    .markdown-content table {
        border-collapse: collapse;
        width: 100%;
    }
    
    .markdown-content th, .markdown-content td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    
    .markdown-content tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    
    .advanced-settings {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #ddd;
    }
    
    .advanced-toggle {
        cursor: pointer;
        color: #2196F3;
        display: inline-block;
        margin-bottom: 10px;
    }
    
    .advanced-toggle:hover {
        text-decoration: underline;
    }
    
    .advanced-content {
        display: none;
    }
    
    .settings-section {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #ddd;
    }
    
    .settings-section:last-child {
        border-bottom: none;
    }
    
    .settings-section h3 {
        margin-top: 0;
        margin-bottom: 10px;
    }
    
    #loading {
        margin-top: 10px;
        font-style: italic;
        color: #666;
    }
    
    .input-container {
        display: flex;
        flex-direction: column;
    }
    
    .input-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* Hiệu ứng đang gõ */
    .typing-indicator {
        display: inline-block;
        width: 20px;
        height: 10px;
        position: relative;
    }
    
    .typing-indicator span {
        display: inline-block;
        width: 5px;
        height: 5px;
        background-color: #888;
        border-radius: 50%;
        position: absolute;
        bottom: 0;
        animation: typing 1s infinite;
    }
    
    .typing-indicator span:nth-child(1) {
        left: 0;
        animation-delay: 0.1s;
    }
    
    .typing-indicator span:nth-child(2) {
        left: 7px;
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        left: 14px;
        animation-delay: 0.3s;
    }
    
    @keyframes typing {
        0% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0); }
    }
    
    /* Nút dừng stream */
    #stop-button {
        background-color: #f44336;
    }
    
    #stop-button:hover {
        background-color: #d32f2f;
    }
    
    /* Toggle switch cho streaming */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
        margin-right: 10px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: #4CAF50;
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }
    
    .toggle-container {
        display: flex;
        align-items: center;
        margin-top: 10px;
    }
    
    /* Nút chỉnh sửa tin nhắn người dùng */
    .edit-button {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: transparent;
        color: #2196F3;
        border: none;
        padding: 5px;
        cursor: pointer;
        font-size: 14px;
        margin: 0;
    }
    
    .edit-button:hover {
        color: #0b7dda;
        background-color: rgba(33, 150, 243, 0.1);
        border-radius: 50%;
    }
    
    /* Nút đọc văn bản */
    .tts-button {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: transparent;
        color: #4CAF50;
        border: none;
        padding: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 0;
    }
    
    .tts-button:hover {
        color: #45a049;
        background-color: rgba(76, 175, 80, 0.1);
        border-radius: 50%;
    }
    
    .tts-button.playing {
        color: #f44336;
    }
    
    .tts-button.paused {
        color: #ff9800;
    }
    
    /* Trạng thái nút Cập nhật */
    .editing-mode {
        background-color: #ff9800;
    }
    
    .editing-mode:hover {
        background-color: #e68a00;
    }
    
    .user-message-content {
        margin-right: 25px; /* Tạo khoảng trống cho nút chỉnh sửa */
    }
    
    @media (max-width: 768px) {
        .button-container {
            flex-direction: row;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            min-width: calc(50% - 5px);
            margin-right: 0;
            margin-bottom: 5px;
            padding: 10px 5px;
        }
    }
</style>
</head>
<body>
    <div class="top-bar">
        <h1 class="app-title">OpenRouter.ai Free Models Client</h1>
        <button class="settings-toggle" id="settings-toggle">
            <i class="fas fa-cog"></i> Cài đặt
        </button>
    </div>
    
    <div class="main-container">
        <!-- Settings Panel (Mặc định ẩn) -->
        <div class="settings-panel" id="settings-panel">
            <div class="settings-section">
                <h3>API và Mô hình</h3>
                <label for="api-key">API Key:</label>
                <input type="password" id="api-key" placeholder="Nhập API key của OpenRouter.ai">
                
                <label for="model-select">Chọn mô hình:</label>
                <select id="model-select">
                    <option value="google/gemini-2.0-pro-exp-02-05:free">Google: Gemini Pro 2.0 Experimental (free)</option>
                    <option value="google/gemini-2.0-flash-lite-preview-02-05:free">Google: Gemini Flash Lite 2.0 Preview (free)</option>
                    <option value="google/gemini-2.0-flash-thinking-exp:free">Google: Gemini 2.0 Flash Thinking Experimental 01-21 (free)</option>
                    <option value="deepseek/deepseek-chat:free">DeepSeek: DeepSeek: DeepSeek V3 (free)</option>
                </select>
            </div>
            
            <div class="settings-section">
                <h3>Cài đặt Phản hồi</h3>
                <label for="temperature">Temperature: <span id="temp-value">0.7</span></label>
                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                
                <label for="max-tokens">Max Tokens:</label>
                <input type="number" id="max-tokens" value="2048" min="1" max="4096">
                
                <div style="margin-top: 10px;">
                    <input type="checkbox" id="format-markdown" checked>
                    <label for="format-markdown">Định dạng Markdown trong phản hồi</label>
                </div>
                
                <div class="toggle-container">
                    <label class="toggle-switch">
                        <input type="checkbox" id="enable-streaming" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <label for="enable-streaming">Bật chế độ streaming (hiển thị nội dung dần dần)</label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Cài đặt Giọng nói</h3>
                <label for="voice-select">Chọn giọng đọc:</label>
                <select id="voice-select">
                    <option value="Vietnamese Male">Tiếng Việt - Giọng Nam</option>
                    <option value="Vietnamese Female">Tiếng Việt - Giọng Nữ</option>
                    <option value="UK English Male">Tiếng Anh (UK) - Giọng Nam</option>
                    <option value="UK English Female">Tiếng Anh (UK) - Giọng Nữ</option>
                    <option value="US English Male">Tiếng Anh (US) - Giọng Nam</option>
                    <option value="US English Female">Tiếng Anh (US) - Giọng Nữ</option>
                </select>
                
                <div style="margin-top: 10px;">
                    <label>Tốc độ đọc: <span id="rate-value">1</span></label>
                    <input type="range" id="speech-rate" min="0.5" max="1.5" step="0.1" value="1">
                </div>
                
                <div style="margin-top: 10px;">
                    <label>Cao độ: <span id="pitch-value">1</span></label>
                    <input type="range" id="speech-pitch" min="0.5" max="2" step="0.1" value="1">
                </div>
            </div>
            
            <div class="settings-section">
                <h3>System Prompt</h3>
                <textarea id="system-prompt" placeholder="Nhập system prompt ở đây (mặc định trống)"></textarea>
                <p style="font-size: 0.9em; color: #666;">System prompt giúp định hướng AI cách phản hồi. Ví dụ: "Bạn là một trợ lý gia sư dạy toán" hoặc "Hãy trả lời ngắn gọn bằng tiếng Việt".</p>
                
                <div class="button-container">
                    <button id="save-system-prompt">Lưu System Prompt</button>
                    <button id="clear-system-prompt">Xóa System Prompt</button>
                </div>
            </div>
        </div>
        
        <!-- Chat Container (Luôn hiển thị) -->
        <div class="chat-container">            
            <div class="chat-history" id="chat-history"></div>
            
            <div class="input-container">
                <label for="user-input">Tin nhắn của bạn:</label>
                <textarea id="user-input" placeholder="Nhập tin nhắn của bạn ở đây..."></textarea>
                
                <div class="input-actions">
                    <div class="button-container">
                        <button id="send-button"><i class="fas fa-paper-plane"></i> Gửi</button>
                        <button id="stop-button" style="display: none;"><i class="fas fa-stop"></i> Dừng</button>
                        <button id="clear-button"><i class="fas fa-trash"></i> Xóa chat</button>
                        <button id="copy-button"><i class="fas fa-copy"></i> Sao chép</button>
                        <button id="download-button"><i class="fas fa-download"></i> Tải xuống</button>
                    </div>
                    
                    <div id="loading" style="display: none;">Đang xử lý...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="status" class="status" style="display: none;"></div>
    <div class="progress-bar">
        <div id="progressBar" class="progress"></div>
    </div>
    <div id="loading-overlay" class="loading">
        <div class="spinner"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Phần điều khiển hiển thị settings panel
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsPanel = document.getElementById('settings-panel');
            const modelSelect = document.getElementById('model-select');
            
            // Kiểm tra trạng thái đã lưu
            const settingsVisible = localStorage.getItem('settings_visible') === 'true';
            
            // Thiết lập trạng thái mặc định (ẩn)
            if (settingsVisible) {
                settingsPanel.classList.add('visible');
                settingsToggle.innerHTML = '<i class="fas fa-times"></i> Đóng cài đặt';
            }
            
            settingsToggle.addEventListener('click', function() {
                settingsPanel.classList.toggle('visible');
                const isVisible = settingsPanel.classList.contains('visible');
                
                // Lưu trạng thái
                localStorage.setItem('settings_visible', isVisible);
                
                // Thay đổi nội dung nút
                if (isVisible) {
                    settingsToggle.innerHTML = '<i class="fas fa-times"></i> Đóng cài đặt';
                } else {
                    settingsToggle.innerHTML = '<i class="fas fa-cog"></i> Cài đặt';
                }
            });
            
            // Cài đặt Marked.js để xử lý Markdown
            marked.setOptions({
                renderer: new marked.Renderer(),
                highlight: function(code, language) {
                    const validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
                    return hljs.highlight(validLanguage, code).value;
                },
                pedantic: false,
                gfm: true,
                breaks: true,
                sanitize: false,
                smartypants: false,
                xhtml: false
            });
            
            // Update temperature value display
            const tempSlider = document.getElementById('temperature');
            const tempValue = document.getElementById('temp-value');
            
            tempSlider.addEventListener('input', function() {
                tempValue.textContent = this.value;
            });
            
            // TTS - Text to Speech Settings
            const speechRate = document.getElementById('speech-rate');
            const rateValue = document.getElementById('rate-value');
            
            speechRate.addEventListener('input', function() {
                rateValue.textContent = this.value;
            });
            
            const speechPitch = document.getElementById('speech-pitch');
            const pitchValue = document.getElementById('pitch-value');
            
            speechPitch.addEventListener('input', function() {
                pitchValue.textContent = this.value;
            });
            
            // Handle send button click
            const sendButton = document.getElementById('send-button');
            const stopButton = document.getElementById('stop-button');
            const userInput = document.getElementById('user-input');
            const chatHistory = document.getElementById('chat-history');
            const apiKeyInput = document.getElementById('api-key');
            const maxTokensInput = document.getElementById('max-tokens');
            const loadingIndicator = document.getElementById('loading');
            const formatMarkdownCheckbox = document.getElementById('format-markdown');
            const streamingCheckbox = document.getElementById('enable-streaming');
            const systemPromptInput = document.getElementById('system-prompt');
            
            // Biến để kiểm soát controller cho fetch API (để có thể dừng stream)
            let abortController = null;
            
            // Biến để theo dõi trạng thái TTS
            let currentTtsElement = null;
            let isTtsSpeaking = false;
            let ttsPosition = 0;
            
            // Load saved settings if available
            if (localStorage.getItem('openrouter_api_key')) {
                apiKeyInput.value = localStorage.getItem('openrouter_api_key');
            }
            
            if (localStorage.getItem('system_prompt')) {
                systemPromptInput.value = localStorage.getItem('system_prompt');
            }
            
            if (localStorage.getItem('selected_model')) {
                modelSelect.value = localStorage.getItem('selected_model');
            }
            
            if (localStorage.getItem('temperature')) {
                const savedTemp = localStorage.getItem('temperature');
                tempSlider.value = savedTemp;
                tempValue.textContent = savedTemp;
            }
            
            if (localStorage.getItem('max_tokens')) {
                maxTokensInput.value = localStorage.getItem('max_tokens');
            }
            
            if (localStorage.getItem('speech_rate')) {
                const savedRate = localStorage.getItem('speech_rate');
                speechRate.value = savedRate;
                rateValue.textContent = savedRate;
            }
            
            if (localStorage.getItem('speech_pitch')) {
                const savedPitch = localStorage.getItem('speech_pitch');
                speechPitch.value = savedPitch;
                pitchValue.textContent = savedPitch;
            }
            
            if (localStorage.getItem('voice_select')) {
                document.getElementById('voice-select').value = localStorage.getItem('voice_select');
            }
            
            if (localStorage.getItem('enable_streaming') !== null) {
                streamingCheckbox.checked = localStorage.getItem('enable_streaming') === 'true';
            }
            
            // Lưu cài đặt streaming
            streamingCheckbox.addEventListener('change', function() {
                localStorage.setItem('enable_streaming', this.checked);
            });
            
            // Lưu cài đặt TTS
            document.getElementById('voice-select').addEventListener('change', function() {
                localStorage.setItem('voice_select', this.value);
            });
            
            speechRate.addEventListener('change', function() {
                localStorage.setItem('speech_rate', this.value);
            });
            
            speechPitch.addEventListener('change', function() {
                localStorage.setItem('speech_pitch', this.value);
            });
            
            // System prompt buttons
            document.getElementById('save-system-prompt').addEventListener('click', function() {
                localStorage.setItem('system_prompt', systemPromptInput.value);
                showStatus('System prompt đã được lưu!');
            });
            
            document.getElementById('clear-system-prompt').addEventListener('click', function() {
                systemPromptInput.value = '';
                localStorage.removeItem('system_prompt');
                showStatus('System prompt đã được xóa!');
            });
            
            // Dừng stream khi nhấn nút dừng
            stopButton.addEventListener('click', function() {
                if (abortController) {
                    abortController.abort();
                    abortController = null;
                    stopButton.style.display = 'none';
                    sendButton.style.display = 'inline-block';
                    loadingIndicator.style.display = 'none';
                    showStatus('Đã dừng sinh nội dung');
                }
            });
            
            let messages = [];
            let systemPromptAdded = false;
            
            sendButton.addEventListener('click', async function() {
    const userMessage = userInput.value.trim();
    const apiKey = apiKeyInput.value.trim();
    const systemPrompt = systemPromptInput.value.trim();
    const useStreaming = streamingCheckbox.checked;
    
    if (!userMessage) {
        showStatus('Vui lòng nhập tin nhắn!', true);
        return;
    }
    
    if (!apiKey) {
        showStatus('Vui lòng nhập API key!', true);
        settingsPanel.classList.add('visible');
        localStorage.setItem('settings_visible', 'true');
        settingsToggle.innerHTML = '<i class="fas fa-times"></i> Đóng cài đặt';
        return;
    }
    
    // Save settings
    localStorage.setItem('openrouter_api_key', apiKey);
    localStorage.setItem('selected_model', modelSelect.value);
    localStorage.setItem('temperature', tempSlider.value);
    localStorage.setItem('max_tokens', maxTokensInput.value);
    
    // Kiểm tra xem đang chỉnh sửa tin nhắn cũ hay tạo tin nhắn mới
    const editingIndex = userInput.getAttribute('data-editing-index');
    
    if (editingIndex !== null) {
        // Đang chỉnh sửa tin nhắn cũ
        const index = parseInt(editingIndex);
        console.log("Đang cập nhật tin nhắn tại index:", index);
        
        // Cập nhật nội dung tin nhắn trong mảng messages
        messages[index].content = userMessage;
        
        // Cập nhật hiển thị tin nhắn trong chat history
        const messageElement = document.querySelector(`.message[data-index="${index}"]`);
        if (messageElement) {
            const contentDiv = messageElement.querySelector('.user-message-content');
            if (contentDiv) {
                contentDiv.textContent = userMessage;
            }
            
            // XÓA TIN NHẮN: Xóa tất cả các phần tử hiển thị sau tin nhắn được chỉnh sửa
            let nextElement = messageElement.nextElementSibling;
            let removedCount = 0;
            
            console.log("Bắt đầu xóa các phần tử sau tin nhắn được chỉnh sửa");
            while (nextElement) {
                const tempNext = nextElement.nextElementSibling; // Lưu lại phần tử tiếp theo trước khi xóa
                console.log("Xóa phần tử:", nextElement.textContent.substring(0, 20) + "...");
                nextElement.remove();
                nextElement = tempNext;
                removedCount++;
            }
            
            console.log("Đã xóa", removedCount, "tin nhắn từ DOM");
            
            // Cắt bớt mảng messages để chỉ giữ lại tin nhắn đến index hiện tại
            if (index < messages.length - 1) {
                console.log("Cắt mảng messages từ", messages.length, "xuống", index + 1, "phần tử");
                messages = messages.slice(0, index + 1);
            }
        }
        
        // Xóa attribute data-editing-index
        userInput.removeAttribute('data-editing-index');
        
        // Đổi nút gửi về trạng thái bình thường
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Gửi';
        sendButton.classList.remove('editing-mode');
        
        // Thông báo đã cập nhật thành công
        showStatus('Đã cập nhật tin nhắn và xóa các tin nhắn phía sau');
    } else {
        // Tin nhắn mới
        // Nếu đây là tin nhắn đầu tiên và có system prompt
        if (!systemPromptAdded && systemPrompt) {
            // Thêm system prompt vào messages
            messages.push({ role: 'system', content: systemPrompt });
            systemPromptAdded = true;
            
            // Hiển thị system prompt trong chat history (tùy chọn)
            appendSystemMessage(systemPrompt);
        }
        
        // Thêm tin nhắn người dùng vào messages
        messages.push({ role: 'user', content: userMessage });
        
        // Thêm tin nhắn người dùng vào chat history
        appendMessage('user', userMessage);
    }
    
    // Clear input
    userInput.value = '';
    
    // Show loading indicator and stop button for streaming
    loadingIndicator.style.display = 'block';
    
    if (useStreaming) {
        stopButton.style.display = 'inline-block';
        sendButton.style.display = 'none';
    }
    
    // Create assistant message div
    let assistantMessageDiv, assistantContentDiv;
    const assistantMessage = { role: 'assistant', content: '' };
    
    if (useStreaming) {
        // Tạo trước div để hiển thị nội dung streaming
        const result = createAssistantMessageDiv(formatMarkdownCheckbox.checked);
        assistantMessageDiv = result.messageDiv;
        assistantContentDiv = result.contentDiv;
    }
    
    // Tạo abort controller mới để có thể dừng request
    abortController = new AbortController();
    
    try {
        if (useStreaming) {
            // Stream API request
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'OpenRouter HTML Client'
                },
                body: JSON.stringify({
                    model: modelSelect.value,
                    messages: messages,
                    temperature: parseFloat(tempSlider.value),
                    max_tokens: parseInt(maxTokensInput.value),
                    stream: true  // Bật chế độ streaming
                }),
                signal: abortController.signal
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Lỗi API không xác định');
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                // Xử lý từng chunk dữ liệu
                const lines = chunk.split('\n').filter(line => line.trim() !== '');
                
                for (const line of lines) {
                    if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        try {
                            const data = JSON.parse(line.substring(6));
                            if (data.choices && data.choices[0]?.delta?.content) {
                                // Lấy và thêm nội dung mới
                                const contentDelta = data.choices[0].delta.content;
                                assistantMessage.content += contentDelta;
                                
                                // Cập nhật nội dung hiển thị
                                updateStreamContent(assistantContentDiv, assistantMessage.content, formatMarkdownCheckbox.checked);
                            }
                        } catch (e) {
                            console.error('Lỗi xử lý dữ liệu stream:', e, line);
                        }
                    }
                }
            }
            
            // Khi hoàn tất streaming, thêm nút TTS
            addTtsButton(assistantContentDiv, assistantMessage.content);
            
            // Khi hoàn tất streaming
            messages.push(assistantMessage);
        } else {
            // Non-streaming API request
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'OpenRouter HTML Client'
                },
                body: JSON.stringify({
                    model: modelSelect.value,
                    messages: messages,
                    temperature: parseFloat(tempSlider.value),
                    max_tokens: parseInt(maxTokensInput.value),
                    stream: false
                }),
                signal: abortController.signal
            });
            
            const data = await response.json();
            
            if (response.ok) {
                const responseMessage = data.choices[0].message.content;
                messages.push({ role: 'assistant', content: responseMessage });
                const contentDiv = appendMessage('assistant', responseMessage, formatMarkdownCheckbox.checked);
                
                // Thêm nút TTS
                addTtsButton(contentDiv, responseMessage);
            } else {
                console.error('API Error:', data);
                showStatus('Lỗi API: ' + (data.error?.message || 'Không xác định'), true);
            }
        }
    } catch (error) {
        // Nếu không phải là lỗi abort từ người dùng
        if (error.name !== 'AbortError') {
            console.error('Request Error:', error);
            showStatus('Lỗi kết nối: ' + error.message, true);
        }
    } finally {
        // Reset controller và UI state
        abortController = null;
        loadingIndicator.style.display = 'none';
        stopButton.style.display = 'none';
        sendButton.style.display = 'inline-block';
    }
});


// Clear chat history
document.getElementById('clear-button').addEventListener('click', function() {
    chatHistory.innerHTML = '';
    messages = [];
    systemPromptAdded = false;
    showStatus('Đã xóa toàn bộ cuộc trò chuyện');
});

// Copy to clipboard button
document.getElementById('copy-button').addEventListener('click', function() {
    if (messages.length === 0) {
        showStatus('Không có nội dung để sao chép!', true);
        return;
    }
    
    // Extract the latest assistant message
    const lastAssistantMessage = messages.filter(msg => msg.role === 'assistant').pop();
    
    if (!lastAssistantMessage) {
        showStatus('Không có phản hồi của AI để sao chép!', true);
        return;
    }
    
    // Copy to clipboard
    navigator.clipboard.writeText(lastAssistantMessage.content)
        .then(() => {
            showStatus('Đã sao chép phản hồi vào clipboard!');
        })
        .catch(err => {
            console.error('Lỗi khi sao chép:', err);
            showStatus('Không thể sao chép: ' + err, true);
        });
});

// Download chat history
document.getElementById('download-button').addEventListener('click', function() {
    if (messages.length === 0) {
        showStatus('Không có nội dung để tải xuống!', true);
        return;
    }
    
    const chatContent = messages.map(msg => 
        `Role: ${msg.role}\nContent: ${msg.content}\n\n`
    ).join('---\n');
    
    const blob = new Blob([chatContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'chat_history_' + new Date().toISOString().slice(0, 10) + '.txt';
    a.click();
    URL.revokeObjectURL(url);
    showStatus('Đã tải xuống lịch sử chat');
});

// Enter key to send message
userInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendButton.click();
    }
});

// Hàm hiển thị thông báo trạng thái
function showStatus(message, isError = false) {
    const status = document.getElementById('status');
    status.textContent = message;
    status.style.backgroundColor = isError ? '#ffe6e6' : '#e6ffe6';
    status.style.color = isError ? '#cc0000' : '#006600';
    status.style.display = 'block';
    
    setTimeout(() => {
        status.style.opacity = '0';
        setTimeout(() => {
            status.style.opacity = '1';
            status.style.display = 'none';
        }, 300);
    }, 3000);
}

// Hàm chơi TTS cho một phần tử nội dung
function playTTS(element, content) {
    // Dừng TTS đang chạy (nếu có)
    stopTTS();
    
    // Làm sạch Markdown trước khi đọc
    const cleanContent = cleanMarkdownForTTS(content);
    
    const voice = document.getElementById('voice-select').value;
    const rate = document.getElementById('speech-rate').value;
    const pitch = document.getElementById('speech-pitch').value;
    
    // Đánh dấu phần tử đang được đọc
    currentTtsElement = element;
    isTtsSpeaking = true;
    
    // Cập nhật biểu tượng
    updateTtsButton(element, 'playing');
    
    // Bắt đầu đọc
    responsiveVoice.speak(cleanContent, voice, {
        rate: parseFloat(rate),
        pitch: parseFloat(pitch),
        onend: () => {
            // Khi đọc xong
            isTtsSpeaking = false;
            currentTtsElement = null;
            updateTtsButton(element, 'idle');
        }
    });
}

// Hàm làm sạch Markdown để TTS
function cleanMarkdownForTTS(text) {
    let clean = text;
    
    // Loại bỏ các ký hiệu Markdown phổ biến
    clean = clean.replace(/\*\*(.*?)\*\*/g, '$1'); // Bold
    clean = clean.replace(/\*(.*?)\*/g, '$1');     // Italic
    clean = clean.replace(/\[(.*?)\]\((.*?)\)/g, '$1'); // Links
    clean = clean.replace(/\~\~(.*?)\~\~/g, '$1'); // Strikethrough
    clean = clean.replace(/\`(.*?)\`/g, '$1');     // Inline code
    
    // Xử lý tiêu đề
    clean = clean.replace(/^#{1,6}\s+(.*?)$/gm, '$1');
    
    // Xử lý code blocks
    clean = clean.replace(/```[\s\S]*?```/g, 'đoạn mã'); // Thay thế code blocks bằng "đoạn mã"
    
    // Xử lý danh sách
    clean = clean.replace(/^\s*[\*\-\+]\s+(.*?)$/gm, '$1');
    clean = clean.replace(/^\s*\d+\.\s+(.*?)$/gm, '$1');
    
    // Xử lý blockquotes
    clean = clean.replace(/^\s*>\s+(.*?)$/gm, '$1');
    
    // Xử lý dấu hai chấm (:)
    // Thay thế dấu hai chấm bằng dấu cách hoặc dấu phẩy khi nó được dùng như dấu phân cách
    clean = clean.replace(/(\w)\s*:\s*(\w)/g, '$1, $2'); // Thay thế dấu : bằng dấu phẩy giữa các từ
    clean = clean.replace(/(\w)\s*:/g, '$1'); // Xóa dấu : ở cuối từ
    
    // Thay thế dấu : trong cách định nghĩa hoặc giải thích
    clean = clean.replace(/^(.*?):\s*(.*)$/gm, '$1. $2');
    
    return clean;
}

// Hàm dừng TTS
function stopTTS() {
    if (isTtsSpeaking && currentTtsElement) {
        responsiveVoice.cancel();
        updateTtsButton(currentTtsElement, 'idle');
        isTtsSpeaking = false;
        currentTtsElement = null;
    }
}

// Hàm tạm dừng TTS
function pauseTTS(element) {
    if (isTtsSpeaking) {
        responsiveVoice.pause();
        updateTtsButton(element, 'paused');
    }
}

// Hàm tiếp tục TTS
function resumeTTS(element) {
    if (currentTtsElement === element) {
        responsiveVoice.resume();
        updateTtsButton(element, 'playing');
    }
}

// Cập nhật trạng thái nút TTS
function updateTtsButton(element, state) {
    const button = element.querySelector('.tts-button');
    if (!button) return;
    
    button.classList.remove('playing', 'paused');
    
    if (state === 'playing') {
        button.innerHTML = '<i class="fas fa-stop"></i>';
        button.classList.add('playing');
        button.title = 'Dừng đọc';
    } else if (state === 'paused') {
        button.innerHTML = '<i class="fas fa-play"></i>';
        button.classList.add('paused');
        button.title = 'Tiếp tục đọc';
    } else {
        button.innerHTML = '<i class="fas fa-volume-up"></i>';
        button.title = 'Đọc văn bản';
    }
}

// Thêm nút TTS vào phần tử nội dung
function addTtsButton(contentDiv, text) {
    const ttsButton = document.createElement('button');
    ttsButton.className = 'tts-button';
    ttsButton.innerHTML = '<i class="fas fa-volume-up"></i>';
    ttsButton.title = 'Đọc văn bản';
    
    ttsButton.addEventListener('click', function() {
        if (isTtsSpeaking) {
            // Nếu đang phát và là phần tử hiện tại
            if (currentTtsElement === contentDiv) {
                // Kiểm tra xem đang tạm dừng hay không
                if (responsiveVoice.isPlaying()) {
                    pauseTTS(contentDiv);
                } else {
                    resumeTTS(contentDiv);
                }
            } else {
                // Nếu đang phát nhưng không phải phần tử hiện tại
                stopTTS();
                playTTS(contentDiv, text);
            }
        } else {
            // Nếu không phát, bắt đầu phát
            playTTS(contentDiv, text);
        }
    });
    
    contentDiv.appendChild(ttsButton);
}

// Helper function to append system message to chat history
function appendSystemMessage(content) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', 'system');
    
    const roleSpan = document.createElement('strong');
    roleSpan.textContent = 'System: ';
    
    const contentDiv = document.createElement('div');
    contentDiv.classList.add('response');
    contentDiv.textContent = content;
    
    messageDiv.appendChild(roleSpan);
    messageDiv.appendChild(contentDiv);
    
    chatHistory.appendChild(messageDiv);
    
    // Scroll to bottom
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

// Helper function để tạo div hiển thị tin nhắn của assistant
function createAssistantMessageDiv(formatAsMarkdown = false) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', 'assistant');
    
    const roleSpan = document.createElement('strong');
    roleSpan.textContent = 'AI: ';
    
    const contentDiv = document.createElement('div');
    if (formatAsMarkdown) {
        contentDiv.classList.add('markdown-content');
    } else {
        contentDiv.classList.add('response');
    }
    
    // Thêm chỉ báo đang gõ
    const typingIndicator = document.createElement('div');
    typingIndicator.classList.add('typing-indicator');
    typingIndicator.innerHTML = '<span></span><span></span><span></span>';
    contentDiv.appendChild(typingIndicator);
    
    messageDiv.appendChild(roleSpan);
    messageDiv.appendChild(contentDiv);
    
    chatHistory.appendChild(messageDiv);
    
    // Scroll to bottom
    chatHistory.scrollTop = chatHistory.scrollHeight;
    
    return { messageDiv, contentDiv };
}

// Helper function để cập nhật nội dung khi streaming
function updateStreamContent(contentDiv, content, formatAsMarkdown = false) {
    // Xóa chỉ báo đang gõ nếu có
    const typingIndicator = contentDiv.querySelector('.typing-indicator');
    if (typingIndicator) {
        contentDiv.removeChild(typingIndicator);
    }
    
    if (formatAsMarkdown) {
        // Sử dụng DOMPurify để làm sạch HTML trước khi chèn vào trang
        contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(content));
        // Highlight code blocks
        contentDiv.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);
        });
    } else {
        contentDiv.textContent = content;
    }
    
    // Scroll to bottom
    chatHistory.scrollTop = chatHistory.scrollHeight;
}



// Helper function to append messages to chat history
function appendMessage(role, content, formatAsMarkdown = false) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', role);
    
    // Đặt data-index dựa trên vị trí trong mảng messages
    const messageIndex = messages.length - 1;
    messageDiv.setAttribute('data-index', messageIndex);
    
    const roleSpan = document.createElement('strong');
    roleSpan.textContent = role === 'user' ? 'Bạn: ' : 'AI: ';
    
    const contentDiv = document.createElement('div');
    
    if (role === 'user') {
        contentDiv.classList.add('response', 'user-message-content');
        contentDiv.textContent = content;
        
        // Thêm nút chỉnh sửa cho tin nhắn người dùng
        const editButton = document.createElement('button');
        editButton.className = 'edit-button';
        editButton.innerHTML = '<i class="fas fa-edit"></i>';
        editButton.title = 'Chỉnh sửa tin nhắn';
        
        editButton.addEventListener('click', function() {
            // Lấy index từ thuộc tính data-index
            const messageIndex = parseInt(messageDiv.getAttribute('data-index'));
            
            // Lấy nội dung hiện tại từ DOM thay vì dùng tham số content
            const currentContent = contentDiv.textContent;
            
            // Đặt nội dung vào ô nhập liệu
            userInput.value = currentContent;
            userInput.focus();
            
            // Đánh dấu đang chỉnh sửa
            userInput.setAttribute('data-editing-index', messageIndex);
            
            // Đổi nút gửi thành nút cập nhật
            sendButton.innerHTML = '<i class="fas fa-sync"></i> Cập nhật';
            sendButton.classList.add('editing-mode');
        });
        
        messageDiv.appendChild(editButton);
    } else if (role === 'assistant') {
        if (formatAsMarkdown) {
            contentDiv.classList.add('markdown-content');
            // Sử dụng DOMPurify để làm sạch HTML trước khi chèn vào trang
            contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(content));
            
            // Highlight code blocks
            contentDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
            
            // Thêm nút TTS cho tin nhắn AI
            addTtsButton(contentDiv, content);
        } else {
            contentDiv.classList.add('response');
            contentDiv.textContent = content;
            
            // Thêm nút TTS cho tin nhắn AI
            addTtsButton(contentDiv, content);
        }
    }
    
    messageDiv.appendChild(roleSpan);
    messageDiv.appendChild(contentDiv);
    
    chatHistory.appendChild(messageDiv);
    
    // Scroll to bottom
    chatHistory.scrollTop = chatHistory.scrollHeight;
    
    return contentDiv;
}

// Khởi tạo trạng thái ban đầu
function init() {
    // Kiểm tra xem ResponsiveVoice đã tải hoàn tất chưa
    if (typeof responsiveVoice !== 'undefined') {
        responsiveVoice.init();
        console.log('ResponsiveVoice đã được khởi tạo');
    } else {
        console.error('ResponsiveVoice chưa được tải');
    }
    
    showStatus('Sẵn sàng trò chuyện');
}

// Khởi tạo ứng dụng
init();
});
</script>
</body>
</html>
